# Recent Android App Changes (2026-01-15)

This log covers the app work done over the last few hours in `TripleUMDM`.
It focuses on performance, background churn, and reliability.

## New App Detection (block_new_apps)
- Replaced the 20s polling `AppMonitorService` flow with event-driven reconciliation.
- Added `AppMonitorReconciler` (debounced, 5s) to run `AppMonitorUtils.monitorOnce` only when needed.
- `AppInstallReceiver` now schedules a reconcile for every add/remove broadcast.
- `ConfigPoller` and `PrivacyFragment` trigger reconcile when the block-new-apps flag or approvals change.
- Boot path (`BootComplete`) now triggers a reconcile if block-new-apps is enabled and stops `AppMonitorService`.
- `NewAppDetector` remains scheduled as a periodic fallback.

Behavioral note:
- Detection can now be delayed by the debounce (default 5s), and a reboot can cancel a pending reconcile.
- The follow-up reconcile on the next package event or boot now closes that gap.

## Cloud Sync Load + Responsiveness
- `CloudSyncManager.tickSync` now runs only when:
  - local config is dirty, or
  - remote data is stale, or
  - listener is not attached.
- Remote updates still apply immediately via the Firestore snapshot listener.
- When remote entries apply locally, `ConfigPoller.applyNow()` runs to make device changes fast.
- Added `ConfigStore.lastWriteAtMs()` tracking and split local writes vs. remote writes:
  - Local writes mark dirty (trigger future push).
  - Remote writes do not mark dirty (avoids sync loops).
- Refactored `syncOnce` to smaller handlers and added a `SyncState` helper struct.

## VPN2 Watcher Load
- `Vpn2RemoteWatcher.tick` no longer re-applies every 5s if stable.
- It now schedules work only when:
  - a handshake is pending,
  - VPN should be active but is not (throttled),
  - or VPN should be off but is active (slow enforcement).

## Update Apps Screen Performance
- Precomputed launchable packages during refresh (avoids per-app PM queries later).
- Offloaded app snapshot / Firestore payload generation to background.
- Added LRU caches for icons and indicator lists (limits memory churn).
- Added indicator-key caching so indicators only rebuild when policy state changes.
- Icons now decode in background on demand; UI uses cached icons and a letter fallback until ready.

## Updates UI Performance
- `UpdatesViewModel` now uses set lookups instead of repeated list scans.
- `partitionUpdates` is now a single pass split (less allocation churn).

## Settings Screen Refactor
- `SettingsFragment.onCreateView` broken into small helpers.
- New Compose builders for state/actions/dialogs to reduce cyclomatic complexity.
- Added missing `@Composable` import so Settings builds cleanly.

## Detekt / Lint
- Detekt enabled with project config and baseline.
- `FunctionNaming` ignores `@Composable` to reduce noise.
- Performance rules enabled.
- Detekt is now clean after the refactors.

## Notable File/Module Touchpoints
- New: `app/src/main/java/com/tripleu/appcontrol/AppMonitorReconciler.kt`
- Updated: `app/src/main/java/com/tripleu/appcontrol/AppInstallReceiver.kt`
- Updated: `app/src/main/java/com/tripleu/config/CloudSyncManager.kt`
- Updated: `app/src/main/java/com/tripleu/config/ConfigStore.kt`
- Updated: `app/src/main/java/com/tripleu/config/ConfigPoller.kt`
- Updated: `app/src/main/java/com/tripleu/ui/fragments/PrivacyFragment.kt`
- Updated: `app/src/main/java/com/tripleu/vpn/BootComplete.java`
- Updated: `app/src/main/java/com/tripleu/vpn2/Vpn2RemoteWatcher.kt`
- Updated: `app/src/main/java/com/tripleu/ui/fragments/UpdateAppsFragment.kt`
- Updated: `app/src/main/java/com/tripleu/updates/UpdatesViewModel.kt`
- Updated: `app/src/main/java/com/tripleu/ui/fragments/SettingsFragment.kt`
- Updated: `config/detekt/detekt.yml`

## Tests / Build Runs
- `./gradlew detekt`
- `./gradlew installDebug`
  - Known warnings: device-owner set/unset errors in emulator tasks, and cmdline-tools path warning.

## Follow-up Options
- Reduce reconcile debounce (5s -> 1-2s) if detection latency is too noticeable.
- Add a low-frequency fallback reconcile (6-12h) if you want a safety net for missed broadcasts.
