import{_ as a,c as i,o as t,ae as o}from"./chunks/framework.Cqi9LMMK.js";const u=JSON.parse('{"title":"App state sync","description":"","frontmatter":{},"headers":[],"relativePath":"android-app/invisible-features/app-state-sync.md","filePath":"android-app/invisible-features/app-state-sync.md"}'),l={name:"android-app/invisible-features/app-state-sync.md"};function r(s,e,c,p,d,n){return t(),i("div",null,[...e[0]||(e[0]=[o('<h1 id="app-state-sync" tabindex="-1">App state sync <a class="header-anchor" href="#app-state-sync" aria-label="Permalink to &quot;App state sync&quot;">​</a></h1><h2 id="app-snapshot-storage-apps-collection" tabindex="-1">App snapshot storage (apps collection) <a class="header-anchor" href="#app-snapshot-storage-apps-collection" aria-label="Permalink to &quot;App snapshot storage (apps collection)&quot;">​</a></h2><h3 id="where-it-lives" tabindex="-1">Where it lives <a class="header-anchor" href="#where-it-lives" aria-label="Permalink to &quot;Where it lives&quot;">​</a></h3><ul><li><code>app/src/main/java/com/tripleu/config/AppSnapshotStorage.kt</code></li><li><code>app/src/main/java/com/tripleu/appcontrol/AppInstallReceiver.kt</code></li><li><code>app/src/main/java/com/tripleu/appcontrol/NewAppDetectorWorker.kt</code></li><li><code>app/src/main/java/com/tripleu/ui/fragments/UpdateAppsFragment.kt</code></li><li><code>app/src/main/java/com/tripleu/vpn/AdVpnService.java</code></li><li><code>app/src/main/java/com/tripleu/vpn/AdVpnServiceKt.kt</code></li></ul><h3 id="what-it-does" tabindex="-1">What it does <a class="header-anchor" href="#what-it-does" aria-label="Permalink to &quot;What it does&quot;">​</a></h3><ul><li>Mirrors per-app policy state into Firestore <code>devices/{deviceId}/apps/{package}</code>.</li><li>Ensures <code>updatedAtMs</code> and <code>deviceId</code> are present on every write.</li><li><code>markApproved</code> sets <code>approved=true</code> and clears <code>hidden</code> + <code>suspended</code>.</li></ul><h3 id="how-it-runs" tabindex="-1">How it runs <a class="header-anchor" href="#how-it-runs" aria-label="Permalink to &quot;How it runs&quot;">​</a></h3><ul><li><code>upsertPackage()</code> merges fields with <code>SetOptions.merge()</code>.</li><li>Called when: <ul><li>New apps are detected and blocked.</li><li>Apps are approved or unblocked.</li><li>VPN/app policy changes are mirrored.</li></ul></li></ul><h2 id="app-remote-watcher" tabindex="-1">App remote watcher <a class="header-anchor" href="#app-remote-watcher" aria-label="Permalink to &quot;App remote watcher&quot;">​</a></h2><h3 id="where-it-lives-1" tabindex="-1">Where it lives <a class="header-anchor" href="#where-it-lives-1" aria-label="Permalink to &quot;Where it lives&quot;">​</a></h3><ul><li><code>app/src/main/java/com/tripleu/config/AppRemoteWatcher.kt</code></li><li><code>app/src/main/java/com/tripleu/config/FirestoreDevicePaths.kt</code></li></ul><h3 id="what-it-does-1" tabindex="-1">What it does <a class="header-anchor" href="#what-it-does-1" aria-label="Permalink to &quot;What it does&quot;">​</a></h3><ul><li>Applies per-app policy changes pushed from the portal.</li><li>Keeps device state in sync without opening the Apps screen.</li></ul><h3 id="how-it-runs-1" tabindex="-1">How it runs <a class="header-anchor" href="#how-it-runs-1" aria-label="Permalink to &quot;How it runs&quot;">​</a></h3><ul><li>Listener attach is triggered by <code>PeriodicTaskRunner</code> (5s tick).</li><li>Listens to <code>devices/{deviceId}/apps</code> snapshots once attached.</li><li>For each app doc, applies: <ul><li>hide, suspend, uninstall block.</li><li>network block, WebView block/exception, video block.</li></ul></li><li>Tracks portal-enforced hide/suspend sets in prefs: <ul><li><code>MDMSettings.policy_hidden_apps</code></li><li><code>MDMSettings.policy_suspended_apps</code></li></ul></li><li>Auto-unblock paths skip apps listed in those policy sets.</li><li>If the per-app network block changed, restarts the main VPN so rules apply. <ul><li>Skips the restart when VPN2 is active (<code>Vpn2State.shouldBlockLegacy</code>).</li></ul></li></ul><h2 id="app-inventory-uploader" tabindex="-1">App inventory uploader <a class="header-anchor" href="#app-inventory-uploader" aria-label="Permalink to &quot;App inventory uploader&quot;">​</a></h2><h3 id="where-it-lives-2" tabindex="-1">Where it lives <a class="header-anchor" href="#where-it-lives-2" aria-label="Permalink to &quot;Where it lives&quot;">​</a></h3><ul><li><code>app/src/main/java/com/tripleu/config/AppInventoryUploader.kt</code></li><li><code>app/src/main/java/com/tripleu/config/FirestoreDevicePaths.kt</code></li></ul><h3 id="what-it-does-2" tabindex="-1">What it does <a class="header-anchor" href="#what-it-does-2" aria-label="Permalink to &quot;What it does&quot;">​</a></h3><ul><li>Uploads installed app metadata to Firestore so the portal can manage apps without opening the Apps tab.</li><li>Uploads icons only when the app version changes.</li></ul><h3 id="how-it-runs-2" tabindex="-1">How it runs <a class="header-anchor" href="#how-it-runs-2" aria-label="Permalink to &quot;How it runs&quot;">​</a></h3><ul><li>Triggered by <code>PeriodicTaskRunner</code> (5s tick; throttled to ~5 minutes).</li><li>Writes to <code>devices/{deviceId}/apps/{package}</code> with: <ul><li><code>label</code>, <code>system</code> (non-launchable), <code>versionName</code>, <code>versionCode</code>, <code>installed</code>, <code>source</code>.</li></ul></li><li>Encodes icons as 96px PNG Base64 when version is newer than last upload.</li><li>Calls <code>markDeviceAlive()</code> during uploads.</li></ul>',22)])])}const m=a(l,[["render",r]]);export{u as __pageData,m as default};
