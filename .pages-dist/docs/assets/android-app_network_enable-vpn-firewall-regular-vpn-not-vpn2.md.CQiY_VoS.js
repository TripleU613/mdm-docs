import{_ as o,c as l,o as a,ae as i}from"./chunks/framework.Cqi9LMMK.js";const h=JSON.parse('{"title":"Enable VPN firewall (regular VPN, not VPN2)","description":"","frontmatter":{},"headers":[],"relativePath":"android-app/network/enable-vpn-firewall-regular-vpn-not-vpn2.md","filePath":"android-app/network/enable-vpn-firewall-regular-vpn-not-vpn2.md"}'),r={name:"android-app/network/enable-vpn-firewall-regular-vpn-not-vpn2.md"};function t(n,e,c,d,s,p){return a(),l("div",null,[...e[0]||(e[0]=[i('<h1 id="enable-vpn-firewall-regular-vpn-not-vpn2" tabindex="-1">Enable VPN firewall (regular VPN, not VPN2) <a class="header-anchor" href="#enable-vpn-firewall-regular-vpn-not-vpn2" aria-label="Permalink to &quot;Enable VPN firewall (regular VPN, not VPN2)&quot;">​</a></h1><h2 id="where-it-lives" tabindex="-1">Where it lives <a class="header-anchor" href="#where-it-lives" aria-label="Permalink to &quot;Where it lives&quot;">​</a></h2><ul><li><code>app/src/main/java/com/tripleu/ui/fragments/PrivacyFragment.kt</code></li><li><code>app/src/main/java/com/tripleu/vpn/AdVpnService.java</code></li><li><code>app/src/main/java/com/tripleu/vpn/AdVpnThread.java</code></li><li><code>app/src/main/java/com/tripleu/vpn/VpnPermissionHelper.kt</code></li><li><code>app/src/main/java/com/tripleu/vpn/Command.java</code></li><li><code>app/src/main/java/com/tripleu/policy/PolicyManager.kt</code></li><li><code>app/src/main/java/com/tripleu/policy/VpnPolicyController.kt</code></li><li><code>app/src/main/java/com/tripleu/network/FirewallManager.kt</code></li><li><code>app/src/main/java/com/tripleu/config/ConfigPoller.kt</code></li></ul><h2 id="what-it-does" tabindex="-1">What it does <a class="header-anchor" href="#what-it-does" aria-label="Permalink to &quot;What it does&quot;">​</a></h2><ul><li>Starts/stops the main firewall VPN (<code>AdVpnService</code>).</li><li>Sets Always-On VPN and blocks VPN settings changes.</li><li>Stores <code>is_vpn_on</code> (prefs) and <code>network.vpn_enabled</code> (<code>ConfigStore</code>).</li><li>Powers per-app network blocking via the <code>firewall_rules</code> prefs.</li><li>Skips all legacy VPN behavior when premium VPN (WireGuard) is active.</li><li>No MITM: this VPN is DNS/firewall-only and does not proxy Chrome.</li></ul><h2 id="how-it-runs" tabindex="-1">How it runs <a class="header-anchor" href="#how-it-runs" aria-label="Permalink to &quot;How it runs&quot;">​</a></h2><ul><li>Toggle on calls <code>startStopService(true)</code>: <ul><li>Stops <code>WhitelistVpnService</code> to avoid overlap.</li><li>Requires all setup permissions; otherwise redirects to <code>PermissionsCheckActivity</code>.</li><li>Requests VPN consent if needed (<code>VpnService.prepare</code>).</li><li>On success, sets Always-On VPN, applies <code>UserManager.DISALLOW_CONFIG_VPN</code>, and starts <code>AdVpnService</code> with <code>Command.START</code>.</li></ul></li><li>Toggle off stops <code>AdVpnService</code> and removes Always-On + <code>DISALLOW_CONFIG_VPN</code>.</li><li><code>persistAutoStartFlag()</code> writes <code>config.autoStart</code> when VPN or whitelist is enabled.</li><li>Cloud config <code>network.vpn_enabled</code> is applied in <code>ConfigPoller</code> unless <code>Vpn2State.shouldBlockLegacy(...)</code> is true.</li></ul><h2 id="how-app-network-blocking-works" tabindex="-1">How app network blocking works <a class="header-anchor" href="#how-app-network-blocking-works" aria-label="Permalink to &quot;How app network blocking works&quot;">​</a></h2><ul><li>Normal firewall mode (no block-all, no per-app rules): <ul><li><code>AdVpnThread</code> only routes DNS servers through the VPN.</li><li>Non-DNS traffic stays outside the VPN.</li></ul></li><li>Per-app network blocks are stored in <code>firewall_rules</code> (key = package name, value = true).</li><li><code>AdVpnThread</code> reads those keys via <code>loadPerAppBlockedPackages()</code>.</li><li>If the list is not empty and whitelist mode is off, it builds a &quot;Selective VPN&quot;: <ul><li>Adds default routes (<code>0.0.0.0/0</code> and <code>::/0</code>) so VPN captures all traffic.</li><li>Disallows every app except the blocked list (so only blocked apps go through the VPN).</li><li>The VPN thread only handles DNS packets; non-DNS packets are not forwarded.</li></ul></li><li>If whitelist mode is on, per-app blocking is ignored to avoid conflicting VPN modes.</li></ul><h2 id="on-boot" tabindex="-1">On boot <a class="header-anchor" href="#on-boot" aria-label="Permalink to &quot;On boot&quot;">​</a></h2><ul><li><code>BootComplete</code> calls <code>AdVpnService.checkStartVpnOnBoot(...)</code>.</li><li>If <code>config.autoStart</code> is true, setup is complete, and VPN permission is granted: <ul><li>Starts <code>WhitelistVpnService</code> when <code>config.hosts.enabled=true</code>.</li><li>Otherwise starts <code>AdVpnService</code>.</li></ul></li><li>Legacy VPN is skipped if <code>Vpn2State.shouldBlockLegacy(...)</code> is true.</li></ul>',11)])])}const v=o(r,[["render",t]]);export{h as __pageData,v as default};
