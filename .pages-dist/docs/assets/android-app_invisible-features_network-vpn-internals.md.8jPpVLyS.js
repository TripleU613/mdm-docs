import{_ as a,c as i,o,ae as l}from"./chunks/framework.Cqi9LMMK.js";const p=JSON.parse('{"title":"Network + VPN internals","description":"","frontmatter":{},"headers":[],"relativePath":"android-app/invisible-features/network-vpn-internals.md","filePath":"android-app/invisible-features/network-vpn-internals.md"}'),t={name:"android-app/invisible-features/network-vpn-internals.md"};function r(s,e,c,d,n,h){return o(),i("div",null,[...e[0]||(e[0]=[l('<h1 id="network-vpn-internals" tabindex="-1">Network + VPN internals <a class="header-anchor" href="#network-vpn-internals" aria-label="Permalink to &quot;Network + VPN internals&quot;">​</a></h1><h2 id="mode-precedence-what-wins" tabindex="-1">Mode precedence (what wins) <a class="header-anchor" href="#mode-precedence-what-wins" aria-label="Permalink to &quot;Mode precedence (what wins)&quot;">​</a></h2><ul><li>Premium VPN (WireGuard) overrides legacy VPN and whitelist modes.</li><li>Domain whitelist mode disables Private DNS and the main VPN toggle.</li><li>Block all traffic requires the legacy VPN and is disabled while whitelist or premium VPN is active.</li><li>Per-app network blocks are stored in <code>firewall_rules</code>: <ul><li>Legacy VPN uses them to build a selective VPN.</li><li>Premium VPN passes them as excluded apps (those apps bypass the tunnel).</li></ul></li></ul><h2 id="host-file-auto-refresh" tabindex="-1">Host file auto-refresh <a class="header-anchor" href="#host-file-auto-refresh" aria-label="Permalink to &quot;Host file auto-refresh&quot;">​</a></h2><h3 id="where-it-lives" tabindex="-1">Where it lives <a class="header-anchor" href="#where-it-lives" aria-label="Permalink to &quot;Where it lives&quot;">​</a></h3><ul><li><code>app/src/main/java/com/tripleu/dp/RuleDatabaseUpdateJobService.java</code></li><li><code>app/src/main/java/com/tripleu/dp/RuleDatabaseUpdateTask.java</code></li><li><code>app/src/main/java/com/tripleu/dp/RuleDatabaseItemUpdateRunnable.java</code></li><li><code>app/src/main/java/com/tripleu/vpn/SingleWriterMultipleReaderFile.java</code></li><li><code>app/src/main/java/com/tripleu/ui/fragments/SettingsFragment.kt</code></li></ul><h3 id="what-it-does" tabindex="-1">What it does <a class="header-anchor" href="#what-it-does" aria-label="Permalink to &quot;What it does&quot;">​</a></h3><ul><li>Automatically refreshes host files for the VPN rule database.</li><li>Shows a progress notification and reports errors.</li></ul><h3 id="how-it-runs" tabindex="-1">How it runs <a class="header-anchor" href="#how-it-runs" aria-label="Permalink to &quot;How it runs&quot;">​</a></h3><ul><li><code>SettingsFragment</code> calls <code>RuleDatabaseUpdateJobService.scheduleOrCancel(...)</code>.</li><li>If <code>config.hosts.automaticRefresh=true</code>, a daily JobScheduler task is set: <ul><li>requires charging, idle, unmetered network.</li></ul></li><li><code>RuleDatabaseUpdateTask</code> downloads each host source: <ul><li><code>content://</code> sources keep persisted read permission.</li><li>URL sources use HTTP with <code>If-Modified-Since</code>.</li></ul></li><li>On completion: <ul><li>Re-initializes <code>RuleDatabase</code>.</li><li>Refreshes <code>AdVpnService</code> if running.</li><li>Stores errors in <code>RuleDatabaseUpdateTask.lastErrors</code> (shown in <code>MainActivity</code>).</li></ul></li></ul><h2 id="vpn-watchdog-keepalive" tabindex="-1">VPN watchdog keepalive <a class="header-anchor" href="#vpn-watchdog-keepalive" aria-label="Permalink to &quot;VPN watchdog keepalive&quot;">​</a></h2><h3 id="where-it-lives-1" tabindex="-1">Where it lives <a class="header-anchor" href="#where-it-lives-1" aria-label="Permalink to &quot;Where it lives&quot;">​</a></h3><ul><li><code>app/src/main/java/com/tripleu/vpn/VpnWatchdog.java</code></li><li><code>app/src/main/java/com/tripleu/vpn/AdVpnThread.java</code></li></ul><h3 id="what-it-does-1" tabindex="-1">What it does <a class="header-anchor" href="#what-it-does-1" aria-label="Permalink to &quot;What it does&quot;">​</a></h3><ul><li>Sends empty UDP packets to keep the VPN DNS path alive.</li><li>Detects no-response conditions and forces a reconnect.</li></ul><h3 id="how-it-runs-1" tabindex="-1">How it runs <a class="header-anchor" href="#how-it-runs-1" aria-label="Permalink to &quot;How it runs&quot;">​</a></h3><ul><li>Initialized by <code>AdVpnThread</code> with <code>Configuration.watchDog</code>.</li><li>Increases poll timeout on success and sends a ping.</li><li>If no packets are received after a ping, it throws a <code>VpnNetworkException</code> to restart the VPN.</li></ul><h2 id="chrome-safesearch-enforcement" tabindex="-1">Chrome SafeSearch enforcement <a class="header-anchor" href="#chrome-safesearch-enforcement" aria-label="Permalink to &quot;Chrome SafeSearch enforcement&quot;">​</a></h2><h3 id="where-it-lives-2" tabindex="-1">Where it lives <a class="header-anchor" href="#where-it-lives-2" aria-label="Permalink to &quot;Where it lives&quot;">​</a></h3><ul><li><code>app/src/main/java/com/tripleu/policy/ChromePolicyController.kt</code></li><li><code>app/src/main/java/com/tripleu/policy/PolicyManager.kt</code></li><li><code>app/src/main/java/com/tripleu/config/ConfigPoller.kt</code></li></ul><h3 id="what-it-does-2" tabindex="-1">What it does <a class="header-anchor" href="#what-it-does-2" aria-label="Permalink to &quot;What it does&quot;">​</a></h3><ul><li>Forces Google SafeSearch in Chrome.</li><li>Disables Chrome QUIC and DNS-over-HTTPS so filtering stays enforceable.</li><li>When premium VPN is active, forces Chrome to use the MITM explicit proxy on the VPN gateway.</li><li>Clears the proxy when premium VPN is not active.</li></ul><h3 id="how-it-runs-2" tabindex="-1">How it runs <a class="header-anchor" href="#how-it-runs-2" aria-label="Permalink to &quot;How it runs&quot;">​</a></h3><ul><li><code>ConfigPoller</code> calls <code>PolicyManager.setChromeSafeSearch(..., proxyEnabled=Vpn2State.isActive(context))</code> each poll.</li><li><code>Vpn2RemoteWatcher</code> re-applies the policy when premium VPN starts/stops.</li><li>The controller sets application restrictions for installed Chrome packages: <ul><li><code>ForceGoogleSafeSearch=true</code></li><li><code>QuicAllowed=false</code></li><li><code>DnsOverHttpsMode=off</code></li><li><code>DnsOverHttpsTemplates=&quot;&quot;</code></li><li><code>ProxyMode=fixed_servers</code> (only when premium VPN is active)</li><li><code>ProxyServer=http=10.9.0.1:8080;https=10.9.0.1:8080</code> (only when premium VPN is active)</li></ul></li></ul><h3 id="routing-summary" tabindex="-1">Routing summary <a class="header-anchor" href="#routing-summary" aria-label="Permalink to &quot;Routing summary&quot;">​</a></h3><ul><li>Chrome traffic goes to the explicit proxy on the VPN gateway when premium VPN is active.</li><li>Non-Chrome traffic stays in the WireGuard tunnel and is filtered by the VPN-side blocklists (Squid + DNS/ipset).</li></ul><h2 id="vpn2-wireguard-watcher" tabindex="-1">VPN2 WireGuard watcher <a class="header-anchor" href="#vpn2-wireguard-watcher" aria-label="Permalink to &quot;VPN2 WireGuard watcher&quot;">​</a></h2><h3 id="where-it-lives-3" tabindex="-1">Where it lives <a class="header-anchor" href="#where-it-lives-3" aria-label="Permalink to &quot;Where it lives&quot;">​</a></h3><ul><li><code>app/src/main/java/com/tripleu/vpn2/Vpn2RemoteWatcher.kt</code></li><li><code>app/src/main/java/com/tripleu/vpn2/Vpn2WireGuardManager.kt</code></li><li><code>app/src/main/java/com/tripleu/vpn2/Vpn2State.kt</code></li></ul><h3 id="what-it-does-3" tabindex="-1">What it does <a class="header-anchor" href="#what-it-does-3" aria-label="Permalink to &quot;What it does&quot;">​</a></h3><ul><li>Enables the premium WireGuard VPN when the portal allows it.</li><li>Installs managed CA certs for VPN + MITM.</li><li>Suspends legacy VPNs while VPN2 is active.</li></ul><h3 id="how-it-runs-3" tabindex="-1">How it runs <a class="header-anchor" href="#how-it-runs-3" aria-label="Permalink to &quot;How it runs&quot;">​</a></h3><ul><li>Watches the device doc <code>devices/{deviceId}</code> for a <code>vpn</code> object.</li><li>Requires <code>network.premium_vpn_enabled=true</code> plus: <ul><li><code>vpn.active=true</code></li><li>valid <code>vpn.expiresAtMs</code></li><li>non-empty WireGuard fields (<code>wgAddress</code>, <code>wgPort</code>, <code>wgServerPublicKey</code>).</li></ul></li><li>Generates/stores WireGuard private key in <code>vpn2_state</code> prefs.</li><li>Uploads <code>vpn.wgPublicKey</code> if missing or outdated.</li><li>Starts WireGuard with: <ul><li>address <code>wgAddress/32</code></li><li>endpoint <code>wgEndpoint</code> or <code>vpn.kvylock.com</code></li><li>DNS from <code>wgDns</code> or derived from the address</li><li>excluded apps from <code>firewall_rules</code>.</li></ul></li><li>Installs CA certs from assets: <ul><li><code>kvylock.pem</code></li><li><code>mitmproxy-ca.pem</code>.</li></ul></li><li>Sets Always-On + lockdown while active.</li></ul>',33)])])}const m=a(t,[["render",r]]);export{p as __pageData,m as default};
