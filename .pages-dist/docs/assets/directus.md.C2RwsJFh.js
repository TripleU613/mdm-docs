import{_ as i,c as s,o as a,ae as o}from"./chunks/framework.Cqi9LMMK.js";const u=JSON.parse('{"title":"Directus","description":"","frontmatter":{},"headers":[],"relativePath":"directus.md","filePath":"directus.md"}'),d={name:"directus.md"};function l(t,e,c,r,n,p){return a(),s("div",null,[...e[0]||(e[0]=[o(`<h1 id="directus" tabindex="-1">Directus <a class="header-anchor" href="#directus" aria-label="Permalink to &quot;Directus&quot;">​</a></h1><h2 id="overview" tabindex="-1">Overview <a class="header-anchor" href="#overview" aria-label="Permalink to &quot;Overview&quot;">​</a></h2><ul><li>Runs on <code>kvylock</code> in Docker (<code>directus</code> + <code>directus-postgres</code>).</li><li>Image: <code>directus/directus:10.13.1</code>.</li><li>Local port: <code>127.0.0.1:8055</code>.</li><li>Postgres: <code>directus-postgres</code> on <code>127.0.0.1:5432</code>.</li><li>Public path: <code>https://vpn.kvylock.com/directus/</code> (Nginx reverse proxy, basic auth user <code>tripleu</code>, PIN <code>Aa45301826</code>).</li><li>Storage: <ul><li>Postgres data: <code>/opt/directus/postgres</code>.</li><li>Uploads: <code>/opt/directus/uploads</code>.</li><li>Extensions: <code>/opt/directus/extensions</code> (currently empty).</li></ul></li></ul><h2 id="auth-access" tabindex="-1">Auth + access <a class="header-anchor" href="#auth-access" aria-label="Permalink to &quot;Auth + access&quot;">​</a></h2><ul><li>Admin credentials live in <code>/opt/directus/.env</code>.</li><li>Server-side callers fall back to admin login when <code>DIRECTUS_TOKEN</code> is not set.</li><li>Website uses Firebase Functions; Directus is not called from the browser.</li><li>Cloud Functions use a Directus token from env.</li></ul><h2 id="config-env" tabindex="-1">Config + env <a class="header-anchor" href="#config-env" aria-label="Permalink to &quot;Config + env&quot;">​</a></h2><ul><li>Env file: <code>/opt/directus/.env</code>.</li><li>Keys present: <code>KEY</code>, <code>SECRET</code>, <code>ADMIN_EMAIL</code>, <code>ADMIN_PASSWORD</code>, <code>DB_*</code>, <code>PUBLIC_URL</code>, <code>CORS_*</code>.</li><li>CORS origins: <code>http://localhost:3000</code>, <code>https://mdm.tripleu.org</code>.</li><li>Directus base URL defaults to <code>http://127.0.0.1:8055</code> for local callers.</li></ul><h2 id="nginx-routing" tabindex="-1">Nginx routing <a class="header-anchor" href="#nginx-routing" aria-label="Permalink to &quot;Nginx routing&quot;">​</a></h2><ul><li><code>/directus/</code> -&gt; <code>127.0.0.1:8055</code>.</li><li><code>X-Forwarded-Prefix</code> is set to <code>/directus</code>.</li></ul><h2 id="collections-used-by-the-system" tabindex="-1">Collections used by the system <a class="header-anchor" href="#collections-used-by-the-system" aria-label="Permalink to &quot;Collections used by the system&quot;">​</a></h2><h3 id="website-rules-categories" tabindex="-1">Website rules + categories <a class="header-anchor" href="#website-rules-categories" aria-label="Permalink to &quot;Website rules + categories&quot;">​</a></h3><ul><li><code>website_categories</code>: <code>id</code>, <code>name</code>, <code>visibility</code>, <code>parent_id</code>, <code>default_enabled</code>, <code>default_image_blocking</code>, <code>default_gif_blocking</code>, <code>default_word_detection</code>, <code>sort_order</code>.</li><li><code>websites</code>: <code>url</code>, <code>status</code>, <code>allowed</code>, <code>match_type</code>, <code>category_id</code>, <code>image_blocking</code>, <code>gif_blocking</code>, <code>word_detection</code>, <code>offensive_text_filter</code>.</li><li><code>bad_words</code>: <code>word</code>, <code>enabled</code>.</li></ul><h3 id="website-rules-behavior" tabindex="-1">Website rules behavior <a class="header-anchor" href="#website-rules-behavior" aria-label="Permalink to &quot;Website rules behavior&quot;">​</a></h3><ul><li><code>visibility</code> controls the portal lists: <code>public</code>, <code>more</code>, <code>report</code>, <code>security</code>, <code>extreme</code>.</li><li><code>match_type</code> supports <code>contains</code>, <code>startswith</code>, <code>endswith</code>, <code>exact</code>, <code>wildcard</code>.</li><li><code>status</code> and <code>allowed</code> are normalized into allow or block decisions in <code>policy.py</code>.</li><li><code>bad_words</code> are used for response text filtering, not for the search blocker list.</li></ul><h3 id="device-specific-overrides-vpn" tabindex="-1">Device-specific overrides (VPN) <a class="header-anchor" href="#device-specific-overrides-vpn" aria-label="Permalink to &quot;Device-specific overrides (VPN)&quot;">​</a></h3><ul><li><code>vpn_category_prefs</code>: <code>device_id</code>, <code>category_id</code>, <code>enabled</code>, <code>image_blocking</code>, <code>word_detection</code>.</li><li><code>vpn_site_overrides</code>: <code>device_id</code>, <code>host</code>, <code>enabled_override</code>, <code>image_policy</code>, <code>word_policy</code>.</li></ul><h3 id="override-behavior" tabindex="-1">Override behavior <a class="header-anchor" href="#override-behavior" aria-label="Permalink to &quot;Override behavior&quot;">​</a></h3><ul><li>Category prefs can override defaults and are inherited from parent categories.</li><li>Site overrides can force allow or force block and override image or word policy.</li><li>Device ids come from WireGuard <code># device:&lt;id&gt;</code> tags and match the Android <code>device-&lt;uuid&gt;</code> id.</li><li>Website VPN tab writes <code>vpn_category_prefs</code> and <code>vpn_site_overrides</code> when allowing categories or sites.</li></ul><h3 id="appeals" tabindex="-1">Appeals <a class="header-anchor" href="#appeals" aria-label="Permalink to &quot;Appeals&quot;">​</a></h3><ul><li><code>vpn_appeals</code>: created by the MITM portal for access appeals.</li><li><code>website_appeals</code>: created by the MITM portal for review/report requests.</li></ul><h3 id="appeals-flow" tabindex="-1">Appeals flow <a class="header-anchor" href="#appeals-flow" aria-label="Permalink to &quot;Appeals flow&quot;">​</a></h3><ul><li>Portal writes <code>website_appeals</code> for review or report requests.</li><li>Portal writes <code>vpn_appeals</code> for access requests with <code>device_id</code>.</li><li><code>appeal-approver.timer</code> promotes approved appeals into <code>websites</code> rules.</li><li>Common fields captured: <code>url</code>, <code>host</code>, <code>request_type</code>, <code>reason</code>, <code>status</code>, <code>client_ip</code>, <code>user_agent</code>.</li><li><code>vpn_appeals</code> defaults <code>status</code> to <code>pending</code> in the MITM policy writer.</li></ul><h3 id="appeal-approver-behavior" tabindex="-1">Appeal approver behavior <a class="header-anchor" href="#appeal-approver-behavior" aria-label="Permalink to &quot;Appeal approver behavior&quot;">​</a></h3><ul><li>Runs every minute via <code>appeal-approver.timer</code>.</li><li>Reads <code>website_appeals</code> with <code>status=approved</code>.</li><li>Normalizes host from <code>host</code> or <code>url</code>.</li><li>Ensures <code>Uncategorized</code> exists if requested category name does not match.</li><li>Upserts <code>websites</code> with: <ul><li><code>url</code> set to the host</li><li><code>match_type=endswith</code></li><li><code>status=allowed</code>, <code>allowed=true</code></li><li><code>image_blocking</code> and <code>offensive_text_filter</code> from the appeal fields</li><li><code>category_id</code> from the requested category name</li></ul></li></ul><h3 id="blocklists-allowlists" tabindex="-1">Blocklists / allowlists <a class="header-anchor" href="#blocklists-allowlists" aria-label="Permalink to &quot;Blocklists / allowlists&quot;">​</a></h3><ul><li><code>app_urls</code>: <code>urls</code> (Squid blocklist; enforced by Squid).</li><li><code>gifs</code>: <code>url</code> (Squid blocklist; enforced by Squid).</li><li><code>maps</code>: <code>url</code> (Squid blocklist notes; enforced by Squid).</li><li><code>squid-general_block</code>: <code>url</code> (Squid blocklist; enforced by Squid).</li><li><code>mitm_block_domains</code>: <code>domain</code> (and <code>enabled</code> when present).</li><li><code>mitm_ignore_domains</code>: <code>domain</code>.</li><li>Any collection with <code>meta.group = &quot;apps&quot;</code> is treated as an extra per-device Squid blocklist: <ul><li>The portal shows one toggle per collection.</li><li>Lists may use <code>url</code> or <code>urls</code> fields (domain or host rules).</li><li>Collection names are normalized to lowercase snake-case for list keys.</li></ul></li></ul><h2 id="field-map-observed-in-code" tabindex="-1">Field map (observed in code) <a class="header-anchor" href="#field-map-observed-in-code" aria-label="Permalink to &quot;Field map (observed in code)&quot;">​</a></h2><p>Note: fields below are the ones referenced by the server, website, or import scripts.</p><h3 id="website-categories" tabindex="-1">website_categories <a class="header-anchor" href="#website-categories" aria-label="Permalink to &quot;website_categories&quot;">​</a></h3><ul><li><code>id</code>, <code>name</code>, <code>description</code></li><li><code>visibility</code>, <code>parent_id</code>, <code>sort_order</code></li><li><code>default_enabled</code>, <code>default_image_blocking</code>, <code>default_gif_blocking</code>, <code>default_word_detection</code></li></ul><h3 id="websites" tabindex="-1">websites <a class="header-anchor" href="#websites" aria-label="Permalink to &quot;websites&quot;">​</a></h3><ul><li><code>url</code>, <code>status</code>, <code>allowed</code>, <code>match_type</code>, <code>category_id</code></li><li><code>image_blocking</code>, <code>gif_blocking</code>, <code>word_detection</code>, <code>offensive_text_filter</code></li></ul><h3 id="bad-words" tabindex="-1">bad_words <a class="header-anchor" href="#bad-words" aria-label="Permalink to &quot;bad_words&quot;">​</a></h3><ul><li><code>word</code>, <code>enabled</code>, <code>locale</code>, <code>severity</code></li><li><code>created_at</code>, <code>updated_at</code></li></ul><h3 id="vpn-category-prefs" tabindex="-1">vpn_category_prefs <a class="header-anchor" href="#vpn-category-prefs" aria-label="Permalink to &quot;vpn_category_prefs&quot;">​</a></h3><ul><li><code>device_id</code>, <code>category_id</code></li><li><code>enabled</code>, <code>image_blocking</code>, <code>word_detection</code></li></ul><h3 id="vpn-site-overrides" tabindex="-1">vpn_site_overrides <a class="header-anchor" href="#vpn-site-overrides" aria-label="Permalink to &quot;vpn_site_overrides&quot;">​</a></h3><ul><li><code>device_id</code>, <code>host</code></li><li><code>enabled_override</code>, <code>image_policy</code>, <code>word_policy</code></li></ul><h3 id="vpn-squid-prefs" tabindex="-1">vpn_squid_prefs <a class="header-anchor" href="#vpn-squid-prefs" aria-label="Permalink to &quot;vpn_squid_prefs&quot;">​</a></h3><ul><li><code>device_id</code>, <code>list</code></li><li><code>enabled</code></li><li><code>list</code> values: <code>maps</code>, <code>gifs</code>, <code>adblock</code>, <code>general</code>, <code>app_urls</code> (missing row = enabled).</li></ul><h3 id="vpn-squid-lists" tabindex="-1">vpn_squid_lists <a class="header-anchor" href="#vpn-squid-lists" aria-label="Permalink to &quot;vpn_squid_lists&quot;">​</a></h3><ul><li><code>key</code>, <code>label</code>, <code>description</code>, <code>sort</code></li><li>Display labels for per-device Squid blocklists.</li></ul><h3 id="vpn-appeals" tabindex="-1">vpn_appeals <a class="header-anchor" href="#vpn-appeals" aria-label="Permalink to &quot;vpn_appeals&quot;">​</a></h3><ul><li><code>url</code>, <code>host</code>, <code>category_id</code>, <code>category_name</code></li><li><code>reason</code>, <code>request_type</code>, <code>status</code></li><li><code>client_ip</code>, <code>user_agent</code>, <code>device_id</code></li><li><code>created_at</code></li></ul><h3 id="website-appeals" tabindex="-1">website_appeals <a class="header-anchor" href="#website-appeals" aria-label="Permalink to &quot;website_appeals&quot;">​</a></h3><ul><li><code>url</code>, <code>host</code></li><li><code>requested_category</code>, <code>requested_category_id</code></li><li><code>requested_image_blocking</code>, <code>requested_offensive_text_filter</code></li><li><code>reason</code>, <code>request_type</code>, <code>status</code></li><li><code>client_ip</code>, <code>user_agent</code>, <code>created_at</code></li></ul><h3 id="app-urls" tabindex="-1">app_urls <a class="header-anchor" href="#app-urls" aria-label="Permalink to &quot;app_urls&quot;">​</a></h3><ul><li><code>urls</code></li></ul><h3 id="gifs" tabindex="-1">gifs <a class="header-anchor" href="#gifs" aria-label="Permalink to &quot;gifs&quot;">​</a></h3><ul><li><code>url</code></li></ul><h3 id="mitm-block-domains" tabindex="-1">mitm_block_domains <a class="header-anchor" href="#mitm-block-domains" aria-label="Permalink to &quot;mitm_block_domains&quot;">​</a></h3><ul><li><code>domain</code>, <code>enabled</code> (optional)</li></ul><h3 id="maps" tabindex="-1">maps <a class="header-anchor" href="#maps" aria-label="Permalink to &quot;maps&quot;">​</a></h3><ul><li><code>url</code></li></ul><h3 id="squid-general-block" tabindex="-1">squid-general_block <a class="header-anchor" href="#squid-general-block" aria-label="Permalink to &quot;squid-general_block&quot;">​</a></h3><ul><li><code>url</code></li></ul><h3 id="mitm-ignore-domains" tabindex="-1">mitm_ignore_domains <a class="header-anchor" href="#mitm-ignore-domains" aria-label="Permalink to &quot;mitm_ignore_domains&quot;">​</a></h3><ul><li><code>domain</code></li></ul><h3 id="app-policies" tabindex="-1">app_policies <a class="header-anchor" href="#app-policies" aria-label="Permalink to &quot;app_policies&quot;">​</a></h3><ul><li><code>package_name</code>, <code>data</code></li><li><code>created_at</code>, <code>updated_at</code></li></ul><h3 id="app-policy-rules" tabindex="-1">app_policy_rules <a class="header-anchor" href="#app-policy-rules" aria-label="Permalink to &quot;app_policy_rules&quot;">​</a></h3><ul><li><code>id</code>, <code>package_name</code>, <code>match_type</code>, <code>action</code>, <code>value</code>, <code>level</code>, <code>enabled</code></li><li><code>created_at</code>, <code>updated_at</code></li></ul><h3 id="website-category-rules" tabindex="-1">website_category_rules <a class="header-anchor" href="#website-category-rules" aria-label="Permalink to &quot;website_category_rules&quot;">​</a></h3><ul><li><code>id</code>, <code>category_id</code>, <code>match_type</code>, <code>action</code>, <code>value</code>, <code>level</code>, <code>enabled</code></li><li><code>created_at</code>, <code>updated_at</code></li></ul><h3 id="store-apps" tabindex="-1">store_apps <a class="header-anchor" href="#store-apps" aria-label="Permalink to &quot;store_apps&quot;">​</a></h3><ul><li><code>id</code>, <code>locale</code>, <code>app_id</code>, <code>title</code>, <code>url</code>, <code>data</code></li><li><code>created_at</code></li></ul><h3 id="app-network-policies" tabindex="-1">app_network_policies <a class="header-anchor" href="#app-network-policies" aria-label="Permalink to &quot;app_network_policies&quot;">​</a></h3><ul><li><code>package_name</code>, <code>category</code>, <code>policy_type</code>, <code>minimum_version_code</code></li><li><code>created_at</code>, <code>updated_at</code></li></ul><h3 id="app-network-variants" tabindex="-1">app_network_variants <a class="header-anchor" href="#app-network-variants" aria-label="Permalink to &quot;app_network_variants&quot;">​</a></h3><ul><li><code>id</code>, <code>package_name</code>, <code>level</code>, <code>user_mode</code>, <code>variant_id</code>, <code>variant_label</code></li><li><code>is_default</code>, <code>mode</code>, <code>source</code></li><li><code>created_at</code>, <code>updated_at</code></li></ul><h3 id="app-network-hosts" tabindex="-1">app_network_hosts <a class="header-anchor" href="#app-network-hosts" aria-label="Permalink to &quot;app_network_hosts&quot;">​</a></h3><ul><li><code>id</code>, <code>variant_id</code>, <code>host</code></li></ul><h3 id="apps-merged-store-table" tabindex="-1">apps (merged store table) <a class="header-anchor" href="#apps-merged-store-table" aria-label="Permalink to &quot;apps (merged store table)&quot;">​</a></h3><ul><li><code>app_id</code></li><li><code>title_en</code>, <code>title_fr</code>, <code>title_he</code></li><li><code>description_en</code>, <code>description_fr</code>, <code>description_he</code></li><li><code>description_html_en</code>, <code>description_html_fr</code>, <code>description_html_he</code></li><li><code>summary_en</code>, <code>summary_fr</code>, <code>summary_he</code></li><li><code>installs</code>, <code>min_installs</code>, <code>real_installs</code></li><li><code>score</code>, <code>ratings</code>, <code>reviews</code></li><li><code>histogram_en</code>, <code>histogram_fr</code>, <code>histogram_he</code></li><li><code>price</code>, <code>free</code>, <code>currency</code></li><li><code>sale</code>, <code>sale_time</code>, <code>original_price</code></li><li><code>sale_text_en</code>, <code>sale_text_fr</code>, <code>sale_text_he</code></li><li><code>offers_iap</code></li><li><code>in_app_product_price_en</code>, <code>in_app_product_price_fr</code>, <code>in_app_product_price_he</code></li><li><code>developer_id</code></li><li><code>privacy_policy_en</code>, <code>privacy_policy_fr</code>, <code>privacy_policy_he</code></li><li><code>genre_en</code>, <code>genre_fr</code>, <code>genre_he</code></li><li><code>genre_id_en</code>, <code>genre_id_fr</code>, <code>genre_id_he</code></li><li><code>icon</code>, <code>header_image</code></li><li><code>screenshots_en</code>, <code>screenshots_fr</code>, <code>screenshots_he</code></li><li><code>video</code>, <code>video_image</code></li><li><code>content_rating_en</code>, <code>content_rating_fr</code>, <code>content_rating_he</code></li><li><code>content_rating_description_en</code>, <code>content_rating_description_fr</code>, <code>content_rating_description_he</code></li><li><code>ad_supported</code>, <code>contains_ads</code>, <code>is_recommended_in_store</code></li><li><code>released</code>, <code>updated</code>, <code>version</code></li><li><code>comments_en</code>, <code>comments_fr</code>, <code>comments_he</code></li><li><code>url_en</code>, <code>url_fr</code>, <code>url_he</code></li><li><code>app_category_id</code></li><li><code>policy_type</code>, <code>policy_category</code>, <code>policy_minimum_version_code</code>, <code>policy_sha1</code>, <code>policy_network_mode</code></li><li><code>created_at</code>, <code>updated_at</code></li></ul><h2 id="rest-endpoints-directus" tabindex="-1">REST endpoints (Directus) <a class="header-anchor" href="#rest-endpoints-directus" aria-label="Permalink to &quot;REST endpoints (Directus)&quot;">​</a></h2><p>Base URL:</p><ul><li>Local: <code>http://127.0.0.1:8055</code></li><li>Public via Nginx: <code>https://vpn.kvylock.com/directus</code> (basic auth user <code>tripleu</code>, PIN <code>Aa45301826</code>)</li></ul><h3 id="auth" tabindex="-1">Auth <a class="header-anchor" href="#auth" aria-label="Permalink to &quot;Auth&quot;">​</a></h3><ul><li><code>POST /auth/login</code> with email and password.</li><li>Response includes an access token used as <code>Authorization: Bearer &lt;token&gt;</code>.</li></ul><p>Example login:</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;email&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;admin@example.com&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;password&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;REDACTED&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>Example login response:</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;data&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;access_token&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;TOKEN&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;expires&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">900000</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="items-api-patterns" tabindex="-1">Items API patterns <a class="header-anchor" href="#items-api-patterns" aria-label="Permalink to &quot;Items API patterns&quot;">​</a></h3><ul><li>List: <code>GET /items/&lt;collection&gt;?limit=-1&amp;fields=field1,field2</code></li><li>Filter: <code>GET /items/&lt;collection&gt;?filter[field][_eq]=value</code></li><li>Create: <code>POST /items/&lt;collection&gt;</code></li><li>Update: <code>PATCH /items/&lt;collection&gt;/&lt;id&gt;</code></li></ul><p>Collections used by the system:</p><ul><li><code>website_categories</code>, <code>websites</code>, <code>bad_words</code></li><li><code>vpn_category_prefs</code>, <code>vpn_site_overrides</code>, <code>vpn_squid_prefs</code>, <code>vpn_squid_lists</code></li><li><code>vpn_appeals</code>, <code>website_appeals</code></li><li><code>app_urls</code>, <code>gifs</code>, <code>maps</code>, <code>squid-general_block</code> (Directus sources)</li><li><code>adblock</code> is local (OISD Full in <code>/opt/squid-blocklist/lists/oisd-full.txt</code>, synced daily).</li><li><code>mitm_block_domains</code>, <code>mitm_ignore_domains</code></li></ul><p>Example category list:</p><div class="language-http vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">http</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">GET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /items/website_categories?limit=-1&amp;fields=id,name,visibility,parent_id,default_enabled,default_image_blocking,default_word_detection,sort_order</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Authorization</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Bearer TOKEN</span></span></code></pre></div><p>Example website rule list:</p><div class="language-http vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">http</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">GET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /items/websites?limit=-1&amp;fields=url,category_id,status,allowed,match_type,image_blocking,gif_blocking,word_detection,offensive_text_filter</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Authorization</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Bearer TOKEN</span></span></code></pre></div><p>Example create vpn appeal:</p><div class="language-http vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">http</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">POST</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /items/vpn_appeals</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Authorization</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Bearer TOKEN</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Content-Type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> application/json</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;url&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;https://example.com/path&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;host&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;example.com&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;category_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">12</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;category_name&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;News&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;reason&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Needed for school&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;request_type&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;appeal&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;status&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;pending&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;client_ip&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;10.9.0.3&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;user_agent&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Android&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;device_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;device-uuid&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>Example create website review request:</p><div class="language-http vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">http</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">POST</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /items/website_appeals</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Authorization</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Bearer TOKEN</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Content-Type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> application/json</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;url&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;example.com&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;host&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;example.com&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;requested_category&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Technology/Internet&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;requested_category_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;reason&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Not sure where this fits&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;request_type&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;review&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;status&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;pending&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;client_ip&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;10.9.0.2&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;user_agent&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Android&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>Example update category defaults:</p><div class="language-http vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">http</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PATCH</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /items/website_categories/7</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Authorization</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Bearer TOKEN</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Content-Type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> application/json</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;default_enabled&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;default_image_blocking&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;default_word_detection&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h2 id="request-map-callers" tabindex="-1">Request map (callers) <a class="header-anchor" href="#request-map-callers" aria-label="Permalink to &quot;Request map (callers)&quot;">​</a></h2><ul><li>MITM policy: reads <code>website_categories</code>, <code>websites</code>, <code>bad_words</code>, <code>vpn_category_prefs</code>, <code>vpn_site_overrides</code>.</li><li>MITM portal: writes <code>vpn_appeals</code> and <code>website_appeals</code>.</li><li>Website VPN tab: reads categories and appeals; writes category prefs and site overrides.</li><li>Cloud Functions: reads categories and appeals; updates category defaults; resolves appeals into <code>websites</code>.</li><li>Appeal approver: reads approved <code>website_appeals</code>, upserts <code>websites</code>.</li></ul><h2 id="integrations" tabindex="-1">Integrations <a class="header-anchor" href="#integrations" aria-label="Permalink to &quot;Integrations&quot;">​</a></h2><ul><li>MITM proxy uses Directus for: <ul><li>website rules, categories, bad words, and per-device overrides.</li><li>SNI domains and ignore list.</li></ul></li><li>Squid blocklist sync uses Directus for: <ul><li>blocklist sources (<code>maps</code>, <code>gifs</code>, <code>squid-general_block</code>, <code>app_urls</code>).</li><li>local list: <code>adblock</code> (OISD Full from <code>/opt/squid-blocklist/lists/oisd-full.txt</code>).</li><li>per-device list toggles (<code>vpn_squid_prefs</code>).</li></ul></li><li>Website uses Directus for VPN categories, blocklists, and appeal actions.</li><li>Cloud Functions call Directus for category defaults and website appeal actions. <ul><li>Functions include <code>listWebsiteCategories</code>, <code>updateWebsiteCategory</code>, <code>listWebsiteAppeals</code>, <code>resolveWebsiteAppeal</code>.</li></ul></li><li>MITM server details: <code>vpn-wireguard</code>.</li></ul><h2 id="admin-scripts-local" tabindex="-1">Admin scripts (local) <a class="header-anchor" href="#admin-scripts-local" aria-label="Permalink to &quot;Admin scripts (local)&quot;">​</a></h2><ul><li><code>/opt/directus/import_directus.py</code>: imports app policies, website rules, and bad words from <code>/opt/apps-db/policies-database.db</code> into Postgres.</li><li><code>/opt/directus/import_app_policies.py</code>: builds <code>app_network_*</code> tables from <code>/opt/apps-db/app-policies</code> JSON.</li><li><code>/opt/directus/merge_apps.py</code>: merges store DBs into an <code>apps</code> table.</li><li>Backup: <code>/opt/directus/directus_backup.dump</code>.</li></ul><h3 id="tables-created-by-import-directus-py" tabindex="-1">Tables created by <code>import_directus.py</code> <a class="header-anchor" href="#tables-created-by-import-directus-py" aria-label="Permalink to &quot;Tables created by \`import_directus.py\`&quot;">​</a></h3><ul><li><code>app_policies</code>, <code>app_policy_rules</code>.</li><li><code>website_categories</code>, <code>website_category_rules</code>.</li><li><code>bad_words</code>, <code>store_apps</code>.</li></ul><h3 id="ops-note" tabindex="-1">Ops note <a class="header-anchor" href="#ops-note" aria-label="Permalink to &quot;Ops note&quot;">​</a></h3><ul><li>No systemd timer/service is configured for these import scripts on <code>kvylock</code>; runs are manual.</li></ul><h2 id="app-policy-data-postgres" tabindex="-1">App policy data (Postgres) <a class="header-anchor" href="#app-policy-data-postgres" aria-label="Permalink to &quot;App policy data (Postgres)&quot;">​</a></h2><ul><li><code>app_network_policies</code> and related <code>app_network_variants</code> and <code>app_network_hosts</code> are created by <code>import_app_policies.py</code>.</li><li>Policies come from JSON files in <code>/opt/apps-db/app-policies</code> and are stored as host lists with variants.</li><li><code>apps</code> and <code>store_apps</code> tables are populated by <code>merge_apps.py</code> for app metadata.</li><li>SQLite sources used by apps-graphql: <code>policies-database.db</code> and <code>store-database-&lt;locale&gt;.db</code>.</li></ul><h2 id="related-services" tabindex="-1">Related services <a class="header-anchor" href="#related-services" aria-label="Permalink to &quot;Related services&quot;">​</a></h2><ul><li><code>appeal-approver.timer</code> runs <code>/opt/appeal-approver/approve.py</code> every minute to sync approved appeals into <code>websites</code>.</li><li><code>apps-graphql.service</code> exists but is currently disabled (serves on <code>127.0.0.1:8010</code> when enabled). <ul><li>App code: <code>/opt/apps-graphql/app.py</code> (Ariadne + Starlette).</li><li>Data source: SQLite DBs in <code>/opt/apps-db</code>.</li><li>Login uses username and PIN from <code>/opt/apps-graphql/app.env</code>.</li><li>Routes: <code>/graphql/login</code>, <code>/graphql/logout</code>, <code>/graphql</code> (GraphQL endpoint).</li><li>Auth uses session cookies; <code>SessionMiddleware</code> is set to <code>https_only</code> with <code>same_site=lax</code>.</li><li>Queries cover policies, store apps, developers, app categories, bad words, and website rules.</li><li>Mutations upsert/delete policies, store apps, developers, categories, bad words, and rules.</li><li>Mutations write back to SQLite; Directus imports from SQLite via <code>import_directus.py</code>.</li><li>Core types: Policy, StoreApp, Developer, AppCategory, GooglePlayCategory, BadWord, AppRule, WebsiteCategory, WebsiteRule.</li></ul></li></ul>`,111)])])}const k=i(d,[["render",l]]);export{u as __pageData,k as default};
