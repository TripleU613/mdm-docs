import{_ as i,c as o,o as a,ae as t}from"./chunks/framework.Cqi9LMMK.js";const p=JSON.parse('{"title":"Config + sync","description":"","frontmatter":{},"headers":[],"relativePath":"android-app/invisible-features/config-sync.md","filePath":"android-app/invisible-features/config-sync.md"}'),l={name:"android-app/invisible-features/config-sync.md"};function c(n,e,s,r,d,h){return a(),o("div",null,[...e[0]||(e[0]=[t('<h1 id="config-sync" tabindex="-1">Config + sync <a class="header-anchor" href="#config-sync" aria-label="Permalink to &quot;Config + sync&quot;">​</a></h1><h2 id="config-store-local-sqlite" tabindex="-1">Config store (local SQLite) <a class="header-anchor" href="#config-store-local-sqlite" aria-label="Permalink to &quot;Config store (local SQLite)&quot;">​</a></h2><h3 id="where-it-lives" tabindex="-1">Where it lives <a class="header-anchor" href="#where-it-lives" aria-label="Permalink to &quot;Where it lives&quot;">​</a></h3><ul><li><code>app/src/main/java/com/tripleu/config/ConfigStore.kt</code></li><li><code>app/src/main/java/com/tripleu/config/ConfigDbHelper.kt</code></li></ul><h3 id="what-it-does" tabindex="-1">What it does <a class="header-anchor" href="#what-it-does" aria-label="Permalink to &quot;What it does&quot;">​</a></h3><ul><li>Stores app config entries in <code>config.db</code> (table <code>config_entries</code>).</li><li>Each entry has <code>config_key</code>, <code>config_value</code>, <code>config_type</code>, <code>updated_at</code>.</li><li>Writes are async on a single-thread executor.</li></ul><h3 id="how-it-runs" tabindex="-1">How it runs <a class="header-anchor" href="#how-it-runs" aria-label="Permalink to &quot;How it runs&quot;">​</a></h3><ul><li><code>initialize()</code> sets up <code>ConfigDbHelper</code>.</li><li><code>putString/Boolean/Int/Long/Json</code> writes with <code>CONFLICT_REPLACE</code>.</li><li><code>getAll()</code> returns <code>ConfigEntry</code> rows for sync and snapshot.</li><li><code>delete()</code> removes a key; <code>shutdown()</code> stops the executor.</li></ul><h2 id="cloud-config-sync" tabindex="-1">Cloud config sync <a class="header-anchor" href="#cloud-config-sync" aria-label="Permalink to &quot;Cloud config sync&quot;">​</a></h2><h3 id="where-it-lives-1" tabindex="-1">Where it lives <a class="header-anchor" href="#where-it-lives-1" aria-label="Permalink to &quot;Where it lives&quot;">​</a></h3><ul><li><code>app/src/main/java/com/tripleu/config/CloudSyncManager.kt</code></li><li><code>app/src/main/java/com/tripleu/config/FirestoreDevicePaths.kt</code></li><li><code>app/src/main/java/com/tripleu/config/ConfigStore.kt</code></li></ul><h3 id="what-it-does-1" tabindex="-1">What it does <a class="header-anchor" href="#what-it-does-1" aria-label="Permalink to &quot;What it does&quot;">​</a></h3><ul><li>Keeps <code>config.db</code> in sync with Firestore.</li><li>Resolves conflicts per key using <code>updatedAtMs</code>.</li><li>Pushes device heartbeat and FCM token.</li><li>Seeds the config doc if it is missing.</li></ul><h3 id="how-it-runs-1" tabindex="-1">How it runs <a class="header-anchor" href="#how-it-runs-1" aria-label="Permalink to &quot;How it runs&quot;">​</a></h3><ul><li>Firestore doc: <code>devices/{deviceId}/config/state/current/current</code>.</li><li>Snapshot listener applies newer remote entries to <code>ConfigStore</code>.</li><li>Uses <code>cloudUpdated</code>/<code>deviceUpdated</code> flags to coordinate which side is newer.</li><li><code>PeriodicTaskRunner</code> drives: <ul><li><code>tickAttach()</code> every ~5s until the listener is attached.</li><li><code>tickSync()</code> every ~30s to push newer local entries.</li><li><code>tickHeartbeat()</code> every ~60s for <code>lastSeenMs</code> + <code>deviceInfo</code>.</li></ul></li><li>On first attach, it creates the config doc and triggers <code>AppInventoryUploader.uploadNow()</code>.</li><li><code>uploadFcmToken()</code> attaches <code>deviceInfo.fcmToken</code> when available.</li><li>If <code>auth.pin_sha256</code> is received, it also stores <code>mdm_pin_hash</code> in <code>MDMSettings</code>.</li></ul><h2 id="config-poller" tabindex="-1">Config poller <a class="header-anchor" href="#config-poller" aria-label="Permalink to &quot;Config poller&quot;">​</a></h2><h3 id="where-it-lives-2" tabindex="-1">Where it lives <a class="header-anchor" href="#where-it-lives-2" aria-label="Permalink to &quot;Where it lives&quot;">​</a></h3><ul><li><code>app/src/main/java/com/tripleu/config/ConfigPoller.kt</code></li></ul><h3 id="what-it-does-2" tabindex="-1">What it does <a class="header-anchor" href="#what-it-does-2" aria-label="Permalink to &quot;What it does&quot;">​</a></h3><ul><li>Applies config changes from <code>ConfigStore</code> to device state.</li><li>Runs continuously when the app is in process and device owner is set.</li></ul><h3 id="how-it-runs-2" tabindex="-1">How it runs <a class="header-anchor" href="#how-it-runs-2" aria-label="Permalink to &quot;How it runs&quot;">​</a></h3><ul><li><code>start()</code> only arms the poller; no internal loop.</li><li><code>PeriodicTaskRunner</code> calls <code>tick()</code> every ~30s to run <code>applyIfChanged()</code>.</li><li>Applies: <ul><li>System restrictions (users, factory reset, APK install, etc).</li><li>App rules (hide/suspend/uninstall/network/webview/video).</li><li>Accessibility flags (WhatsApp blocks, AI, webview block-all, browser dummy mode).</li><li>Network settings (VPN, whitelist, block all traffic, private DNS).</li><li>Settings screen values (language, app density).</li><li>Muted updates and app approvals.</li></ul></li><li>If <code>system.lockout_enabled</code> is true, launches <code>LockoutActivity</code> and sets LockTask.</li></ul><h2 id="initial-config-snapshot" tabindex="-1">Initial config snapshot <a class="header-anchor" href="#initial-config-snapshot" aria-label="Permalink to &quot;Initial config snapshot&quot;">​</a></h2><h3 id="where-it-lives-3" tabindex="-1">Where it lives <a class="header-anchor" href="#where-it-lives-3" aria-label="Permalink to &quot;Where it lives&quot;">​</a></h3><ul><li><code>app/src/main/java/com/tripleu/config/ConfigSnapshotWriter.kt</code></li><li><code>app/src/main/java/com/tripleu/MainActivity.kt</code></li></ul><h3 id="what-it-does-3" tabindex="-1">What it does <a class="header-anchor" href="#what-it-does-3" aria-label="Permalink to &quot;What it does&quot;">​</a></h3><ul><li>Captures a one-time snapshot of device/app/account state.</li><li>Stores the snapshot locally in <code>ConfigStore</code> (not uploaded).</li></ul><h3 id="how-it-runs-3" tabindex="-1">How it runs <a class="header-anchor" href="#how-it-runs-3" aria-label="Permalink to &quot;How it runs&quot;">​</a></h3><ul><li><code>MainActivity</code> calls <code>ConfigSnapshotWriter.ensureInitialSnapshot()</code> after setup.</li><li>Runs only once and only if the app is device owner.</li><li>Writes: <ul><li><code>snapshot.initial_payload</code> (JSON).</li><li><code>snapshot.initial_written_at</code> (timestamp).</li></ul></li><li>Snapshot includes app version, device info, Firebase email/uid, language, density, muted packages, and all <code>ConfigStore</code> entries.</li></ul>',29)])])}const f=i(l,[["render",c]]);export{p as __pageData,f as default};
